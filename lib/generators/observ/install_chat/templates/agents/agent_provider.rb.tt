# Service for discovering and providing available agents
# This is the ONLY class in the Agent domain that knows how to discover agents
#
# Responsibilities:
#   - Loading agent files in development mode (via Zeitwerk)
#   - Discovering all agents that implement AgentSelectable
#   - Sorting and filtering agents
#
# The Observ domain queries this service to get available agents,
# maintaining clean separation between domains.
#
# Usage:
#   agents = AgentProvider.all_agents
#   # => [SimpleAgent, MyCustomAgent, ...]
class AgentProvider
  class << self
    # Returns all available agents that implement the AgentSelectable interface
    # Agents are sorted alphabetically by display_name
    #
    # @return [Array<Class>] array of agent classes
    def all_agents
      ensure_agents_loaded

      BaseAgent.descendants
               .select { |agent_class| agent_class.include?(AgentSelectable) }
               .sort_by(&:display_name)
    end

    private

    # Ensures all agent files are loaded in development mode
    # Uses Zeitwerk's eager_load_dir for thread-safe, Rails-idiomatic loading
    # In production, eager loading handles this automatically (this becomes a no-op)
    def ensure_agents_loaded
      return if Rails.application.config.eager_load

      Rails.autoloaders.main.eager_load_dir(Rails.root.join("app", "agents"))
    end
  end
end
