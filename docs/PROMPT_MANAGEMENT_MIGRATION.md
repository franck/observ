# Agent Infrastructure Migration Guide (v0.3.0+)

## Overview

As of version **0.3.0**, the core agent infrastructure has been moved into the Observ gem with proper namespacing:
- `PromptManagement` → `Observ::PromptManagement`
- `AgentSelectable` → `Observ::AgentSelectable`  
- `AgentProvider` → `Observ::AgentProvider`

This change eliminates code duplication and makes all agent infrastructure available to apps using the gem without requiring generation.

## What Changed?

### PromptManagement Concern

**Before (< 0.3.0):**
- Generated by `rails generate observ:install:chat`
- Located at `app/agents/concerns/prompt_management.rb` in your app
- Included as `include PromptManagement`

**After (≥ 0.3.0):**
- Built into the Observ gem
- Located at `observ/app/models/concerns/observ/prompt_management.rb` in the gem
- Included as `include Observ::PromptManagement`

### AgentSelectable Concern

**Before (< 0.3.0):**
- Generated by `rails generate observ:install:chat`
- Located at `app/agents/concerns/agent_selectable.rb` in your app
- Included as `include AgentSelectable`

**After (≥ 0.3.0):**
- Built into the Observ gem
- Located at `observ/app/models/concerns/observ/agent_selectable.rb` in the gem
- Included as `include Observ::AgentSelectable`

### AgentProvider Service

**Before (< 0.3.0):**
- Generated by `rails generate observ:install:chat`
- Located at `app/agents/agent_provider.rb` in your app
- Referenced as `AgentProvider.all_agents`

**After (≥ 0.3.0):**
- Built into the Observ gem
- Located at `observ/app/services/observ/agent_provider.rb` in the gem
- Referenced as `Observ::AgentProvider.all_agents`

## Migration Steps

If you're upgrading from a version < 0.3.0:

### 1. Update Agent Includes

**For PromptManagement:**

**Before:**
```ruby
class MyAgent < BaseAgent
  include PromptManagement
  # ...
end
```

**After:**
```ruby
class MyAgent < BaseAgent
  include Observ::PromptManagement
  # ...
end
```

**For AgentSelectable:**

**Before:**
```ruby
class MyAgent < BaseAgent
  include AgentSelectable
  # ...
end
```

**After:**
```ruby
class MyAgent < BaseAgent
  include Observ::AgentSelectable
  # ...
end
```

### 2. Delete AgentProvider (Now in Gem)

**AgentProvider is now built into the gem**, so you can delete the generated file:

```bash
rm app/agents/agent_provider.rb
```

If you had customizations, you can configure the agent path instead:

```ruby
# config/initializers/observability.rb
Observ.configure do |config|
  config.agent_path = Rails.root.join("lib", "custom_agents")
end
```

### 3. Update Specs

Update any test files that reference these concerns:

**Before:**
```ruby
Class.new(BaseAgent) do
  include PromptManagement
  include AgentSelectable
  # ...
end
```

**After:**
```ruby
Class.new(BaseAgent) do
  include Observ::PromptManagement
  include Observ::AgentSelectable
  # ...
end
```

### 4. Delete Old Generated Files

After updating all references, you can safely delete:
```bash
rm app/agents/concerns/prompt_management.rb
rm app/agents/concerns/agent_selectable.rb
rm app/agents/agent_provider.rb
```

These files are no longer needed as they now live in the gem.

### 5. Update ChatResponseJob (if applicable)

**Note:** Model parameters are now configured automatically via the `setup_parameters` hook. If your `ChatResponseJob` has the old pattern of passing parameters explicitly, see [MODEL_PARAMETERS_IMPLEMENTATION.md](MODEL_PARAMETERS_IMPLEMENTATION.md) for migration instructions.

**Current correct pattern (no changes needed):**
```ruby
# Parameters are automatically configured via initialize_agent callback
chat.ask(content) do |chunk|
  # ...
end
```

### 6. Run Your Tests

Verify everything works:

```bash
bundle exec rspec
```

## Benefits of This Change

1. **Single Source of Truth**: The concern is maintained in one place (the gem)
2. **Automatic Updates**: Bug fixes and improvements are distributed with gem updates
3. **Cleaner Installation**: No generated concerns, just include the module
4. **Better Namespacing**: Clear indication that it's from the Observ gem

## New Installation Behavior

For new installations (≥ 0.3.0):

```bash
rails generate observ:install:chat
```

Will **NOT** generate concern files. The generator will display:

```
✓ Created BaseAgent
✓ Created AgentProvider
ℹ AgentSelectable is now available as Observ::AgentSelectable (no generation needed)
ℹ PromptManagement is now available as Observ::PromptManagement (no generation needed)
```

Both concerns are automatically available from the gem.

## API Compatibility

The APIs remain **100% compatible**. All methods work exactly the same:

**PromptManagement:**
```ruby
class MyAgent < BaseAgent
  include Observ::PromptManagement
  include Observ::AgentSelectable

  use_prompt_management(
    prompt_name: "my-agent-system-prompt",
    fallback: FALLBACK_PROMPT
  )

  def self.default_model
    "gpt-4o"
  end
  
  def self.default_model_parameters
    { temperature: 0.7, max_tokens: 1000 }
  end
  
  def self.display_name
    "My Agent"
  end
end
```

**PromptManagement methods:**
- `use_prompt_management`
- `fetch_prompt`
- `system_prompt`
- `model` (with prompt config override)
- `model_parameters` (with prompt config override)
- `prompt_metadata`
- `reset_prompt_cache!`

**AgentSelectable methods:**
- `display_name` (required)
- `agent_identifier`
- `description`
- `category`

## Troubleshooting

### Error: `uninitialized constant PromptManagement` or `uninitialized constant AgentSelectable`

This means you're still using the old unnamespaced syntax. Update to:
- `include Observ::PromptManagement`
- `include Observ::AgentSelectable`

### Error: `uninitialized constant Observ::PromptManagement` or `uninitialized constant Observ::AgentSelectable`

Make sure you're using the latest version of the Observ gem (≥ 0.3.0):

```bash
bundle update observ
```

## Questions?

If you encounter any issues during migration, please:

1. Check that all agents are using `include Observ::PromptManagement`
2. Verify your Observ gem version: `bundle info observ`
3. Run your test suite to catch any remaining references
4. Open an issue if problems persist

## Summary

These are **non-breaking changes** with clear migration steps. The APIs remain identical, you just need to:

1. Update `include PromptManagement` → `include Observ::PromptManagement`
2. Update `include AgentSelectable` → `include Observ::AgentSelectable`
3. Delete `AgentProvider` (now `Observ::AgentProvider` in gem)
4. Delete the old generated files (concerns + agent_provider.rb)
5. Check `ChatResponseJob` if applicable (see step 5 above)

**Critical for Agent Selector:** Without deleting the old `AgentProvider`, agents won't appear in the chat selector dropdown because it will use the old unnamespaced version.

**Model Parameters:** For the latest model parameters implementation (using `setup_parameters` hook), see [MODEL_PARAMETERS_IMPLEMENTATION.md](MODEL_PARAMETERS_IMPLEMENTATION.md).
