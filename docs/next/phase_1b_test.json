{
  "phase": "1B",
  "name": "Add Scoreable Concern + Direct Scoring UI",
  "description": "Enable scoring Sessions and Traces directly from the UI via a reusable Scoreable concern",
  "depends_on": "Phase 1A",
  "requirements": [
    {
      "id": "1B.1",
      "category": "concern",
      "file": "app/models/concerns/observ/scoreable.rb",
      "description": "Create Scoreable concern with score helper methods",
      "acceptance_criteria": [
        "Defines has_many :scores, as: :scoreable association when included",
        "Provides #score_for(name, source: nil) method to find score by name and optional source",
        "Provides #scored? method returning true if any scores exist",
        "Provides #manual_score method returning the manual score (name='manual', source='manual')",
        "Provides #score_summary method returning hash of score names to average values"
      ]
    },
    {
      "id": "1B.2",
      "category": "model",
      "file": "app/models/observ/session.rb",
      "description": "Include Scoreable concern in Session model",
      "acceptance_criteria": [
        "Includes Observ::Scoreable concern",
        "Session.new.respond_to?(:scores) returns true",
        "Session.new.respond_to?(:score_for) returns true",
        "Session.new.respond_to?(:manual_score) returns true"
      ]
    },
    {
      "id": "1B.3",
      "category": "model",
      "file": "app/models/observ/trace.rb",
      "description": "Include Scoreable concern in Trace model",
      "acceptance_criteria": [
        "Includes Observ::Scoreable concern",
        "Trace.new.respond_to?(:scores) returns true",
        "Trace.new.respond_to?(:score_for) returns true",
        "Trace.new.respond_to?(:manual_score) returns true"
      ]
    },
    {
      "id": "1B.4",
      "category": "model",
      "file": "app/models/observ/dataset_run_item.rb",
      "description": "Include Scoreable concern in DatasetRunItem model",
      "acceptance_criteria": [
        "Includes Observ::Scoreable concern",
        "Removes explicit has_many :scores association (now provided by concern)",
        "Existing score helper methods (score_for, scored?) are now provided by concern",
        "Can remove duplicate method definitions if they match concern methods"
      ]
    },
    {
      "id": "1B.5",
      "category": "routes",
      "file": "config/routes.rb",
      "description": "Add nested score routes for sessions and traces",
      "acceptance_criteria": [
        "Sessions have nested scores resource with create and destroy actions",
        "Traces have nested scores resource with create and destroy actions",
        "Routes generate session_scores_path(session) helper",
        "Routes generate trace_scores_path(trace) helper"
      ]
    },
    {
      "id": "1B.6",
      "category": "controller",
      "file": "app/controllers/observ/scores_controller.rb",
      "description": "Create ScoresController for session/trace scoring",
      "acceptance_criteria": [
        "Inherits from Observ::ApplicationController",
        "Has before_action :set_scoreable to find parent resource",
        "create action finds or initializes score by name and source",
        "create action supports boolean scores (value 0 or 1)",
        "create action supports optional comment and created_by params",
        "create action responds to turbo_stream and html formats",
        "destroy action removes the score",
        "destroy action responds to turbo_stream and html formats",
        "set_scoreable handles both session_id and trace_id params"
      ]
    },
    {
      "id": "1B.7",
      "category": "view",
      "file": "app/views/observ/scores/_form.html.erb",
      "description": "Create score form partial",
      "acceptance_criteria": [
        "Accepts scoreable local variable",
        "Renders form with correct URL based on scoreable type (session or trace)",
        "Shows thumbs up/down radio buttons for boolean scoring",
        "Highlights currently selected score if one exists",
        "Includes hidden fields for data_type=boolean and name=manual",
        "Includes optional comment textarea",
        "Has submit button"
      ]
    },
    {
      "id": "1B.8",
      "category": "view",
      "file": "app/views/observ/scores/create.turbo_stream.erb",
      "description": "Create turbo_stream response for score creation",
      "acceptance_criteria": [
        "Updates the score form section to show saved state",
        "Can update score indicator if one exists in the UI"
      ]
    },
    {
      "id": "1B.9",
      "category": "view",
      "file": "app/views/observ/traces/annotations_drawer.turbo_stream.erb",
      "description": "Update trace annotations drawer to include scoring",
      "acceptance_criteria": [
        "Drawer title changes to 'Annotations & Scores' or similar",
        "Includes score form partial above annotations section",
        "Score form is rendered with @trace as scoreable"
      ]
    },
    {
      "id": "1B.10",
      "category": "view",
      "file": "app/views/observ/sessions/annotations_drawer.turbo_stream.erb",
      "description": "Update session annotations drawer to include scoring",
      "acceptance_criteria": [
        "Drawer title changes to 'Annotations & Scores' or similar",
        "Includes score form partial above annotations section",
        "Score form is rendered with @session as scoreable"
      ]
    },
    {
      "id": "1B.11",
      "category": "spec",
      "file": "spec/models/concerns/observ/scoreable_spec.rb",
      "description": "Create specs for Scoreable concern",
      "acceptance_criteria": [
        "Tests that including concern adds scores association",
        "Tests #score_for returns correct score by name",
        "Tests #score_for with source parameter filters by source",
        "Tests #scored? returns true when scores exist",
        "Tests #scored? returns false when no scores exist",
        "Tests #manual_score returns the manual score",
        "Tests #score_summary returns hash of averages"
      ]
    },
    {
      "id": "1B.12",
      "category": "spec",
      "file": "spec/requests/observ/scores_controller_spec.rb",
      "description": "Create request specs for ScoresController",
      "acceptance_criteria": [
        "Tests POST /sessions/:id/scores creates score for session",
        "Tests POST /traces/:id/scores creates score for trace",
        "Tests score creation with value=1 sets value to 1.0",
        "Tests score creation with value=0 sets value to 0.0",
        "Tests score creation with comment saves comment",
        "Tests score update (find_or_initialize) updates existing score",
        "Tests DELETE /sessions/:id/scores/:score_id destroys score",
        "Tests DELETE /traces/:id/scores/:score_id destroys score",
        "Tests turbo_stream response format",
        "Tests html response format with redirect"
      ]
    },
    {
      "id": "1B.13",
      "category": "integration",
      "description": "Direct scoring functionality works end-to-end",
      "acceptance_criteria": [
        "Can score a session from the annotations drawer",
        "Can score a trace from the annotations drawer",
        "Score persists and is visible when drawer is reopened",
        "Changing score (e.g., from pass to fail) updates existing score",
        "All existing tests continue to pass"
      ]
    }
  ],
  "files_to_create": [
    "app/models/concerns/observ/scoreable.rb",
    "app/controllers/observ/scores_controller.rb",
    "app/views/observ/scores/_form.html.erb",
    "app/views/observ/scores/create.turbo_stream.erb",
    "spec/models/concerns/observ/scoreable_spec.rb",
    "spec/requests/observ/scores_controller_spec.rb"
  ],
  "files_to_modify": [
    "app/models/observ/session.rb",
    "app/models/observ/trace.rb",
    "app/models/observ/dataset_run_item.rb",
    "config/routes.rb",
    "app/views/observ/traces/annotations_drawer.turbo_stream.erb",
    "app/views/observ/sessions/annotations_drawer.turbo_stream.erb"
  ],
  "verification_commands": [
    "bundle exec rspec spec/models/concerns/observ/scoreable_spec.rb",
    "bundle exec rspec spec/requests/observ/scores_controller_spec.rb",
    "bundle exec rspec spec/models/observ/session_spec.rb",
    "bundle exec rspec spec/models/observ/trace_spec.rb",
    "bundle exec rspec spec/models/observ/dataset_run_item_spec.rb",
    "bundle exec rspec"
  ]
}
