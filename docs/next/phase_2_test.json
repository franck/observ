{
  "phase": "2",
  "name": "Review Queue",
  "description": "Provide a systematic way to review flagged sessions and traces with guardrails for auto-flagging",
  "depends_on": "Phase 1B",
  "requirements": [
    {
      "id": "2.1",
      "category": "migration",
      "file": "db/migrate/016_create_observ_review_items.rb",
      "description": "Create review_items table migration",
      "acceptance_criteria": [
        "Creates observ_review_items table",
        "Has reviewable_type (string, not null) column",
        "Has reviewable_id (bigint, not null) column",
        "Has status (integer, default 0, not null) column",
        "Has priority (integer, default 0, not null) column",
        "Has reason (string) column",
        "Has reason_details (json) column",
        "Has completed_at (datetime) column",
        "Has completed_by (string) column",
        "Has timestamps",
        "Has unique index on [reviewable_type, reviewable_id]",
        "Has composite index on [status, priority, created_at]",
        "Has index on status"
      ]
    },
    {
      "id": "2.2",
      "category": "model",
      "file": "app/models/observ/review_item.rb",
      "description": "Create ReviewItem model",
      "acceptance_criteria": [
        "Uses table name observ_review_items",
        "Has belongs_to :reviewable, polymorphic: true",
        "Has enum :status with values { pending: 0, in_progress: 1, completed: 2, skipped: 3 }",
        "Has enum :priority with values { normal: 0, high: 1, critical: 2 }",
        "Validates presence of reviewable",
        "Validates uniqueness of reviewable_id scoped to reviewable_type",
        "Has scope :actionable returning pending and in_progress items",
        "Has scope :by_priority ordering by priority desc, created_at asc",
        "Has scope :sessions filtering by reviewable_type 'Observ::Session'",
        "Has scope :traces filtering by reviewable_type 'Observ::Trace'",
        "Has #complete!(by:) method setting status to completed with timestamp",
        "Has #skip!(by:) method setting status to skipped with timestamp",
        "Has #start_review! method setting status to in_progress if pending",
        "Has #priority_badge_class returning appropriate CSS class",
        "Has #reason_display returning human-readable reason"
      ]
    },
    {
      "id": "2.3",
      "category": "concern",
      "file": "app/models/concerns/observ/reviewable.rb",
      "description": "Create Reviewable concern",
      "acceptance_criteria": [
        "Defines has_one :review_item, as: :reviewable association",
        "Has #enqueue_for_review!(reason:, priority:, details:) method",
        "enqueue_for_review! returns existing review_item if already queued",
        "enqueue_for_review! creates new review_item if not queued",
        "Has #review_status returning status or 'not_queued'",
        "Has #reviewed? returning true if review completed",
        "Has #pending_review? returning true if pending or in_progress",
        "Has #in_review_queue? returning true if review_item exists"
      ]
    },
    {
      "id": "2.4",
      "category": "model",
      "file": "app/models/observ/session.rb",
      "description": "Include Reviewable concern in Session model",
      "acceptance_criteria": [
        "Includes Observ::Reviewable concern",
        "Session.new.respond_to?(:review_item) returns true",
        "Session.new.respond_to?(:enqueue_for_review!) returns true",
        "Session.new.respond_to?(:in_review_queue?) returns true"
      ]
    },
    {
      "id": "2.5",
      "category": "model",
      "file": "app/models/observ/trace.rb",
      "description": "Include Reviewable concern in Trace model",
      "acceptance_criteria": [
        "Includes Observ::Reviewable concern",
        "Trace.new.respond_to?(:review_item) returns true",
        "Trace.new.respond_to?(:enqueue_for_review!) returns true",
        "Trace.new.respond_to?(:in_review_queue?) returns true"
      ]
    },
    {
      "id": "2.6",
      "category": "routes",
      "file": "config/routes.rb",
      "description": "Add review queue routes",
      "acceptance_criteria": [
        "Has resources :reviews with index and show actions",
        "Has collection routes: sessions, traces, stats",
        "Has member routes: complete, skip",
        "Controller is review_queue",
        "Routes generate reviews_path, review_path(id), etc."
      ]
    },
    {
      "id": "2.7",
      "category": "controller",
      "file": "app/controllers/observ/review_queue_controller.rb",
      "description": "Create ReviewQueueController",
      "acceptance_criteria": [
        "Inherits from Observ::ApplicationController",
        "Has index action showing actionable items by priority",
        "Has sessions action filtering to session reviews only",
        "Has traces action filtering to trace reviews only",
        "Has show action that calls start_review! and loads reviewable",
        "Has complete action that marks review complete and redirects",
        "Has skip action that marks review skipped and redirects",
        "Has stats action showing detailed review statistics",
        "complete and skip support 'next' param to go to next item",
        "Includes queue_stats helper method",
        "Includes next_review_item helper method",
        "Uses pagination via Kaminari"
      ]
    },
    {
      "id": "2.8",
      "category": "service",
      "file": "app/services/observ/guardrail_service.rb",
      "description": "Create GuardrailService for auto-flagging",
      "acceptance_criteria": [
        "Has class method evaluate_trace(trace) applying trace rules",
        "Has class method evaluate_session(session) applying session rules",
        "Has class method evaluate_all_recent(since:) for batch evaluation",
        "Has class method random_sample(scope:, percentage:) for QA sampling",
        "Trace rules include: error_detected (critical), high_cost (high), high_latency (normal), no_output (high), high_token_count (normal)",
        "Session rules include: high_cost (high), short_session (normal), many_traces (normal)",
        "Rules have configurable thresholds",
        "Only enqueues if not already in review queue",
        "Stops after first matching rule (one reason per item)"
      ]
    },
    {
      "id": "2.9",
      "category": "view",
      "file": "app/views/observ/review_queue/index.html.erb",
      "description": "Create review queue index view",
      "acceptance_criteria": [
        "Shows list of pending/in_progress review items",
        "Displays priority badge for each item",
        "Displays reason for each item",
        "Displays reviewable type (Session/Trace)",
        "Has link to review each item",
        "Shows queue stats summary",
        "Has tabs/links to filter by sessions/traces",
        "Uses pagination"
      ]
    },
    {
      "id": "2.10",
      "category": "view",
      "file": "app/views/observ/review_queue/show.html.erb",
      "description": "Create review item detail view",
      "acceptance_criteria": [
        "Shows full context of reviewable (input, output, metrics)",
        "Shows reason why item was flagged",
        "Shows priority badge",
        "Includes score form for scoring the item",
        "Has 'Save & Next' button to complete and go to next",
        "Has 'Skip' button to skip without scoring",
        "Has 'Back to Queue' link",
        "Shows position in queue (e.g., 'Reviewing 1 of 15')"
      ]
    },
    {
      "id": "2.11",
      "category": "view",
      "file": "app/views/observ/review_queue/stats.html.erb",
      "description": "Create review stats view",
      "acceptance_criteria": [
        "Shows total pending reviews count",
        "Shows total completed reviews count",
        "Shows reviews completed today",
        "Shows reviews completed this week",
        "Shows breakdown by reason",
        "Shows breakdown by priority",
        "Shows pass rate (% of positive scores)"
      ]
    },
    {
      "id": "2.12",
      "category": "view",
      "file": "app/views/observ/review_queue/_item.html.erb",
      "description": "Create review item partial",
      "acceptance_criteria": [
        "Displays item in a card/row format",
        "Shows reviewable type icon or label",
        "Shows priority with appropriate styling",
        "Shows reason in human-readable format",
        "Shows created_at timestamp",
        "Has 'Review' link to show page"
      ]
    },
    {
      "id": "2.13",
      "category": "view",
      "file": "app/views/observ/review_queue/_stats.html.erb",
      "description": "Create stats summary partial",
      "acceptance_criteria": [
        "Shows pending count",
        "Shows in_progress count",
        "Shows completed today count",
        "Shows completed this week count",
        "Can be rendered inline on index page"
      ]
    },
    {
      "id": "2.14",
      "category": "navigation",
      "file": "app/views/layouts/observ/application.html.erb",
      "description": "Add Review Queue to main navigation",
      "acceptance_criteria": [
        "Has 'Review Queue' link in main nav",
        "Shows badge with pending count if > 0",
        "Badge uses danger/warning styling"
      ]
    },
    {
      "id": "2.15",
      "category": "spec",
      "file": "spec/models/observ/review_item_spec.rb",
      "description": "Create ReviewItem model specs",
      "acceptance_criteria": [
        "Tests associations (belongs_to :reviewable)",
        "Tests enums (status, priority)",
        "Tests validations (reviewable presence, uniqueness)",
        "Tests scopes (actionable, by_priority, sessions, traces)",
        "Tests #complete! method",
        "Tests #skip! method",
        "Tests #start_review! method",
        "Tests #priority_badge_class method",
        "Tests #reason_display method"
      ]
    },
    {
      "id": "2.16",
      "category": "spec",
      "file": "spec/models/concerns/observ/reviewable_spec.rb",
      "description": "Create Reviewable concern specs",
      "acceptance_criteria": [
        "Tests has_one :review_item association",
        "Tests #enqueue_for_review! creates review item",
        "Tests #enqueue_for_review! returns existing if already queued",
        "Tests #review_status returns correct status",
        "Tests #reviewed? returns true when completed",
        "Tests #pending_review? returns true when pending/in_progress",
        "Tests #in_review_queue? returns true when queued"
      ]
    },
    {
      "id": "2.17",
      "category": "spec",
      "file": "spec/services/observ/guardrail_service_spec.rb",
      "description": "Create GuardrailService specs",
      "acceptance_criteria": [
        "Tests evaluate_trace with error_detected condition",
        "Tests evaluate_trace with high_cost condition",
        "Tests evaluate_trace with high_latency condition",
        "Tests evaluate_trace with no_output condition",
        "Tests evaluate_session with high_cost condition",
        "Tests evaluate_session with short_session condition",
        "Tests that items already in queue are not re-queued",
        "Tests random_sample creates review items",
        "Tests evaluate_all_recent processes recent items"
      ]
    },
    {
      "id": "2.18",
      "category": "spec",
      "file": "spec/requests/observ/review_queue_controller_spec.rb",
      "description": "Create ReviewQueueController request specs",
      "acceptance_criteria": [
        "Tests GET /reviews returns success",
        "Tests GET /reviews shows pending items",
        "Tests GET /reviews/sessions filters to sessions",
        "Tests GET /reviews/traces filters to traces",
        "Tests GET /reviews/:id shows review item",
        "Tests GET /reviews/:id sets status to in_progress",
        "Tests POST /reviews/:id/complete marks complete",
        "Tests POST /reviews/:id/complete redirects to next if param present",
        "Tests POST /reviews/:id/skip marks skipped",
        "Tests GET /reviews/stats shows statistics"
      ]
    },
    {
      "id": "2.19",
      "category": "integration",
      "description": "Review queue works end-to-end",
      "acceptance_criteria": [
        "GuardrailService.evaluate_trace creates review items for matching traces",
        "Review Queue index shows flagged items sorted by priority",
        "Clicking 'Review' shows full item context",
        "Scoring an item and clicking 'Save & Next' completes review",
        "Skipping moves to next item without scoring",
        "Stats page shows accurate counts",
        "Navigation badge shows correct pending count",
        "All existing tests continue to pass"
      ]
    }
  ],
  "files_to_create": [
    "db/migrate/016_create_observ_review_items.rb",
    "app/models/observ/review_item.rb",
    "app/models/concerns/observ/reviewable.rb",
    "app/controllers/observ/review_queue_controller.rb",
    "app/services/observ/guardrail_service.rb",
    "app/views/observ/review_queue/index.html.erb",
    "app/views/observ/review_queue/show.html.erb",
    "app/views/observ/review_queue/stats.html.erb",
    "app/views/observ/review_queue/_item.html.erb",
    "app/views/observ/review_queue/_stats.html.erb",
    "spec/models/observ/review_item_spec.rb",
    "spec/models/concerns/observ/reviewable_spec.rb",
    "spec/services/observ/guardrail_service_spec.rb",
    "spec/requests/observ/review_queue_controller_spec.rb",
    "spec/factories/observ/observ_review_items.rb"
  ],
  "files_to_modify": [
    "app/models/observ/session.rb",
    "app/models/observ/trace.rb",
    "config/routes.rb",
    "app/views/layouts/observ/application.html.erb"
  ],
  "verification_commands": [
    "bundle exec rails db:migrate",
    "bundle exec rspec spec/models/observ/review_item_spec.rb",
    "bundle exec rspec spec/models/concerns/observ/reviewable_spec.rb",
    "bundle exec rspec spec/services/observ/guardrail_service_spec.rb",
    "bundle exec rspec spec/requests/observ/review_queue_controller_spec.rb",
    "bundle exec rspec"
  ]
}
