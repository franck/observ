{
  "phase": "1A",
  "name": "Refactor Score to Polymorphic",
  "description": "Migrate Score model to fully polymorphic design, removing dataset_run_item_id and trace_id in favor of scoreable polymorphic association",
  "requirements": [
    {
      "id": "1A.1",
      "category": "migration",
      "description": "Create migration 015_refactor_scores_to_polymorphic.rb",
      "acceptance_criteria": [
        "Adds scoreable_type (string) column to observ_scores",
        "Adds scoreable_id (bigint) column to observ_scores",
        "Removes foreign key constraint on dataset_run_item_id",
        "Removes foreign key constraint on trace_id",
        "Removes dataset_run_item_id column",
        "Removes trace_id column",
        "Adds index on [scoreable_type, scoreable_id]",
        "Adds unique index on [scoreable_type, scoreable_id, name, source]"
      ]
    },
    {
      "id": "1A.2",
      "category": "model",
      "file": "app/models/observ/score.rb",
      "description": "Update Score model with polymorphic association",
      "acceptance_criteria": [
        "Has belongs_to :scoreable, polymorphic: true association",
        "Has belongs_to :observation, optional: true association",
        "Removes belongs_to :dataset_run_item association",
        "Removes belongs_to :trace association",
        "Validates uniqueness of scoreable_id scoped to [scoreable_type, name, source]",
        "Has scope :for_sessions filtering by scoreable_type 'Observ::Session'",
        "Has scope :for_traces filtering by scoreable_type 'Observ::Trace'",
        "Has scope :for_dataset_run_items filtering by scoreable_type 'Observ::DatasetRunItem'",
        "Has #dataset_run_item method returning scoreable when type is DatasetRunItem",
        "Has #trace method returning trace from scoreable (handles Trace and DatasetRunItem types)",
        "Has #session method returning session from scoreable (handles all types)",
        "Retains existing #passed?, #failed?, #display_value, #badge_class methods"
      ]
    },
    {
      "id": "1A.3",
      "category": "model",
      "file": "app/models/observ/dataset_run_item.rb",
      "description": "Update DatasetRunItem to use polymorphic scores",
      "acceptance_criteria": [
        "Has has_many :scores, as: :scoreable association",
        "Removes explicit foreign_key: :dataset_run_item_id from scores association",
        "Existing score helper methods (score_for, scored?, passing_scores_count, failing_scores_count) still work"
      ]
    },
    {
      "id": "1A.4",
      "category": "service",
      "file": "app/services/observ/evaluators/base_evaluator.rb",
      "description": "Update BaseEvaluator to work with polymorphic scores",
      "acceptance_criteria": [
        "create_or_update_score method no longer assigns trace: run_item.trace",
        "Scores are created via run_item.scores.find_or_initialize_by",
        "Evaluators can still create and update scores for dataset run items"
      ]
    },
    {
      "id": "1A.5",
      "category": "factory",
      "file": "spec/factories/observ/observ_scores.rb",
      "description": "Update Score factory for polymorphic association",
      "acceptance_criteria": [
        "Default factory creates score with scoreable association to DatasetRunItem",
        "Factory no longer sets dataset_run_item or trace directly",
        "Existing traits (:passing, :failing, :boolean, :manual, :programmatic, :with_comment) still work",
        "Can create scores for different scoreable types via traits or transient attributes"
      ]
    },
    {
      "id": "1A.6",
      "category": "spec",
      "file": "spec/models/observ/score_spec.rb",
      "description": "Update Score model specs",
      "acceptance_criteria": [
        "Tests polymorphic belongs_to :scoreable association",
        "Tests optional belongs_to :observation association",
        "Tests uniqueness validation scoped to [scoreable_type, scoreable_id, name, source]",
        "Tests :for_sessions, :for_traces, :for_dataset_run_items scopes",
        "Tests #dataset_run_item convenience method",
        "Tests #trace convenience method for different scoreable types",
        "Tests #session convenience method for different scoreable types",
        "Existing tests for #passed?, #failed?, #display_value, #badge_class still pass"
      ]
    },
    {
      "id": "1A.7",
      "category": "integration",
      "description": "Existing dataset scoring functionality works",
      "acceptance_criteria": [
        "DatasetRunItemsController#score action creates scores correctly",
        "BaseEvaluator and subclasses create scores for run items",
        "EvaluatorRunnerService runs evaluators and scores are persisted",
        "Dataset run review page displays scores correctly",
        "All existing specs in spec/services/observ/evaluators/ pass",
        "All existing specs in spec/requests/observ/dataset_run_items_controller_spec.rb pass",
        "All existing specs in spec/models/observ/dataset_run_item_spec.rb pass"
      ]
    }
  ],
  "files_to_create": [
    "db/migrate/015_refactor_scores_to_polymorphic.rb"
  ],
  "files_to_modify": [
    "app/models/observ/score.rb",
    "app/models/observ/dataset_run_item.rb",
    "app/services/observ/evaluators/base_evaluator.rb",
    "spec/factories/observ/observ_scores.rb",
    "spec/models/observ/score_spec.rb"
  ],
  "verification_commands": [
    "bundle exec rails db:migrate",
    "bundle exec rspec spec/models/observ/score_spec.rb",
    "bundle exec rspec spec/models/observ/dataset_run_item_spec.rb",
    "bundle exec rspec spec/services/observ/evaluators/",
    "bundle exec rspec spec/requests/observ/dataset_run_items_controller_spec.rb",
    "bundle exec rspec"
  ]
}
