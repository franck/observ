<% content_for :title, "#{@run.name} - #{@dataset.name}" %>

<% content_for :page_header do %>
  <div class="observ-page-header__content">
    <div class="observ-page-header__breadcrumb">
      <%= link_to "Datasets", datasets_path, class: "observ-link" %> /
      <%= link_to @dataset.name, dataset_path(@dataset, tab: "runs"), class: "observ-link" %> /
    </div>
    <h1 class="observ-page-header__title"><%= @run.name %></h1>
    <% if @run.description.present? %>
      <p class="observ-page-header__subtitle"><%= @run.description %></p>
    <% end %>
  </div>
  <div class="observ-page-header__actions">
    <%= link_to "Review Items", review_dataset_run_path(@dataset, @run),
      class: "observ-button observ-button--primary" %>
    <%= button_to "Run Evaluators", run_evaluators_dataset_run_path(@dataset, @run),
      method: :post,
      class: "observ-button observ-button--secondary",
      disabled: @run.in_progress? %>
    <%= button_to "Delete Run", dataset_run_path(@dataset, @run),
      method: :delete,
      class: "observ-button observ-button--danger",
      data: { confirm: "Are you sure you want to delete this run?" } %>
  </div>
<% end %>

<div class="observ-container">
  <!-- Run Summary -->
  <section class="observ-card">
    <div class="observ-card__body">
      <!-- Progress Section -->
      <div class="observ-datasets__run-progress">
        <div class="observ-datasets__run-progress-header">
          <span class="observ-badge <%= run_status_badge_class(@run.status) %>">
            <%= @run.status %>
          </span>
          <span class="observ-datasets__run-progress-stats">
            <%= @run.completed_items %> / <%= @run.total_items %> completed
            <% if @run.failed_items > 0 %>
              <span class="observ-text--danger">(<%= @run.failed_items %> failed)</span>
            <% end %>
          </span>
        </div>
        <div class="observ-datasets__progress">
          <div class="observ-datasets__progress-bar">
            <div class="observ-datasets__progress-fill observ-datasets__progress-fill--success"
                 style="width: <%= @run.success_rate %>%"></div>
            <div class="observ-datasets__progress-fill observ-datasets__progress-fill--danger"
                 style="width: <%= @run.failure_rate %>%"></div>
          </div>
          <span class="observ-datasets__progress-text">
            <%= @run.progress_percentage %>%
          </span>
        </div>
      </div>

      <!-- Metadata Grid -->
      <dl class="observ-datasets__metadata observ-datasets__metadata--horizontal">
        <div class="observ-datasets__metadata-item">
          <dt class="observ-datasets__metadata-label">Total Cost</dt>
          <dd class="observ-datasets__metadata-value">$<%= number_with_precision(@run.total_cost, precision: 4) %></dd>
        </div>
        <div class="observ-datasets__metadata-item">
          <dt class="observ-datasets__metadata-label">Total Tokens</dt>
          <dd class="observ-datasets__metadata-value"><%= number_with_delimiter(@run.total_tokens) %></dd>
        </div>
        <div class="observ-datasets__metadata-item">
          <dt class="observ-datasets__metadata-label">Created</dt>
          <dd class="observ-datasets__metadata-value"><%= @run.created_at.strftime("%b %d, %Y at %I:%M %p") %></dd>
        </div>
        <% if @run.scores.any? %>
          <div class="observ-datasets__metadata-item">
            <dt class="observ-datasets__metadata-label">Score Summary</dt>
            <dd class="observ-datasets__metadata-value">
              <% @run.score_summary.each do |name, avg| %>
                <span class="observ-badge observ-badge--sm"><%= name %>: <%= (avg * 100).round(1) %>%</span>
              <% end %>
            </dd>
          </div>
          <div class="observ-datasets__metadata-item">
            <dt class="observ-datasets__metadata-label">Items Scored</dt>
            <dd class="observ-datasets__metadata-value"><%= @run.items_with_scores_count %> / <%= @run.total_items %></dd>
          </div>
        <% end %>
      </dl>
    </div>
  </section>

  <!-- Run Items -->
  <section class="observ-card">
    <div class="observ-card__header">
      <h2 class="observ-card__title">Run Items</h2>
    </div>
    <div class="observ-card__body">
      <% if @run_items.any? %>
        <table class="observ-table">
          <thead class="observ-table__header">
            <tr class="observ-table__row">
              <th class="observ-table__cell">Input</th>
              <th class="observ-table__cell">Expected</th>
              <th class="observ-table__cell">Actual</th>
              <th class="observ-table__cell">Scores</th>
              <th class="observ-table__cell observ-table__cell--actions"></th>
            </tr>
          </thead>
          <tbody>
            <% @run_items.each do |run_item| %>
              <tr class="observ-table__row">
                <td class="observ-table__cell observ-datasets__cell--preview">
                  <code class="observ-datasets__preview"><%= run_item.dataset_item.input_preview(max_length: 60) %></code>
                </td>
                <td class="observ-table__cell observ-datasets__cell--preview">
                  <% if run_item.expected_output.present? %>
                    <code class="observ-datasets__preview"><%= run_item.dataset_item.expected_output_preview(max_length: 60) %></code>
                  <% else %>
                    <span class="observ-text--muted">-</span>
                  <% end %>
                </td>
                <td class="observ-table__cell observ-datasets__cell--preview">
                  <% if run_item.actual_output.present? %>
                    <code class="observ-datasets__preview"><%= truncate(run_item.actual_output.to_s, length: 60) %></code>
                  <% elsif run_item.failed? %>
                    <span class="observ-text--danger" title="<%= run_item.error %>">Error: <%= truncate(run_item.error, length: 40) %></span>
                  <% else %>
                    <span class="observ-text--muted">Pending</span>
                  <% end %>
                </td>
                <%= render "observ/dataset_run_items/scores_cell", run_item: run_item %>
                <td class="observ-table__cell observ-table__cell--actions">
                  <div class="observ-datasets-table__action-group">
                    <% if run_item.succeeded? %>
                      <%= link_to "Score",
                        "#",
                        class: "observ-button observ-button--sm",
                        data: {
                          action: "click->observ--drawer#open",
                          drawer_url_param: score_drawer_dataset_run_run_item_path(@dataset, @run, run_item)
                        } %>
                    <% end %>
                    <%= link_to "Details",
                      "#",
                      class: "observ-button observ-button--sm",
                      data: {
                        action: "click->observ--drawer#open",
                        drawer_url_param: details_drawer_dataset_run_run_item_path(@dataset, @run, run_item)
                      } %>
                    <% if run_item.trace %>
                      <%= link_to "Trace", trace_path(run_item.trace), class: "observ-button observ-button--sm" %>
                    <% end %>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>

        <%= observ_pagination(@run_items) %>
      <% else %>
        <div class="observ-card__empty">
          <p class="observ-card__empty-text">No items in this run</p>
        </div>
      <% end %>
    </div>
  </section>
</div>
