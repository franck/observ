<% content_for :title, "Review - #{@run.name}" %>

<% content_for :page_header do %>
  <div class="observ-page-header__content">
    <div class="observ-page-header__breadcrumb">
      <%= link_to "Datasets", datasets_path, class: "observ-link" %> /
      <%= link_to @dataset.name, dataset_path(@dataset, tab: "runs"), class: "observ-link" %> /
      <%= link_to @run.name, dataset_run_path(@dataset, @run), class: "observ-link" %> /
    </div>
    <h1 class="observ-page-header__title">Review Mode</h1>
  </div>
  <div class="observ-page-header__actions">
    <%= link_to "Exit Review", dataset_run_path(@dataset, @run), class: "observ-button" %>
  </div>
<% end %>

<div class="observ-container">
  <!-- Progress Bar -->
  <section class="observ-review__progress-section">
    <div class="observ-review__progress-header">
      <span class="observ-review__progress-label">
        Scoring Progress: <strong><%= @progress[:scored] %></strong> of <strong><%= @progress[:total] %></strong> items
      </span>
      <span class="observ-review__progress-percent">
        <%= @progress[:total] > 0 ? ((@progress[:scored].to_f / @progress[:total]) * 100).round(0) : 0 %>%
      </span>
    </div>
    <div class="observ-datasets__progress">
      <div class="observ-datasets__progress-bar">
        <div class="observ-datasets__progress-fill observ-datasets__progress-fill--success"
             style="width: <%= @progress[:total] > 0 ? ((@progress[:scored].to_f / @progress[:total]) * 100) : 0 %>%"></div>
      </div>
    </div>
  </section>

  <!-- Review Card -->
  <section class="observ-card observ-review__card">
    <div class="observ-card__header">
      <h2 class="observ-card__title">Item #<%= @run_item.id %></h2>
      <% if @run_item.trace %>
        <%= link_to "View Trace", trace_path(@run_item.trace), class: "observ-button observ-button--sm", target: "_blank" %>
      <% end %>
    </div>

    <div class="observ-card__body">
      <!-- Input / Expected / Actual Grid -->
      <div class="observ-review__data-grid">
        <div class="observ-review__data-section">
          <h3 class="observ-review__data-label">Input</h3>
          <pre class="observ-code-block observ-review__code-block"><%= format_trace_data(@run_item.input) %></pre>
        </div>

        <% if @run_item.expected_output.present? %>
          <div class="observ-review__data-section">
            <h3 class="observ-review__data-label">Expected Output</h3>
            <pre class="observ-code-block observ-review__code-block"><%= format_trace_data(@run_item.expected_output) %></pre>
          </div>
        <% end %>

        <div class="observ-review__data-section observ-review__data-section--highlight">
          <h3 class="observ-review__data-label">Actual Output</h3>
          <pre class="observ-code-block observ-review__code-block"><%= format_trace_data(@run_item.actual_output) %></pre>
        </div>
      </div>

      <!-- Existing Scores (if any) -->
      <% if @run_item.scores.any? %>
        <div class="observ-review__existing-scores">
          <h4 class="observ-text--label">Existing Scores</h4>
          <ul class="observ-scores-list">
            <% @run_item.scores.each do |score| %>
              <li class="observ-scores-list__item">
                <span class="observ-scores-list__indicator <%= score.passed? ? 'observ-scores-list__indicator--pass' : 'observ-scores-list__indicator--fail' %>">
                  <%= score.passed? ? '✓' : '✗' %>
                </span>
                <span class="observ-scores-list__name"><%= score.name %></span>
                <% unless score.boolean? %>
                  <span class="observ-scores-list__value"><%= score.display_value %></span>
                <% end %>
                <span class="observ-scores-list__source"><%= score.source %></span>
              </li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <!-- Scoring Form -->
      <%= form_with url: score_dataset_run_run_item_path(@dataset, @run, @run_item),
                    method: :post,
                    class: "observ-review__form",
                    data: { turbo: false } do |f| %>
        <%= hidden_field_tag :review_mode, "1" %>

        <div class="observ-review__scoring-section">
          <h3 class="observ-review__scoring-label">Is the output correct?</h3>

          <div class="observ-review__score-buttons">
            <label class="observ-review__score-button observ-review__score-button--pass">
              <input type="radio" name="value" value="1" <%= "checked" if @existing_manual&.passed? %>>
              <span class="observ-review__score-icon">&#10003;</span>
              <span class="observ-review__score-text">Correct</span>
              <span class="observ-review__score-shortcut">Press C</span>
            </label>

            <label class="observ-review__score-button observ-review__score-button--fail">
              <input type="radio" name="value" value="0" <%= "checked" if @existing_manual&.failed? %>>
              <span class="observ-review__score-icon">&#10005;</span>
              <span class="observ-review__score-text">Incorrect</span>
              <span class="observ-review__score-shortcut">Press X</span>
            </label>
          </div>

          <div class="observ-form__group observ-review__comment-group">
            <label class="observ-form__label" for="comment">Comment (optional)</label>
            <textarea name="comment" id="comment" class="observ-form__textarea" rows="2" placeholder="Add notes about this score..."><%= @existing_manual&.comment %></textarea>
          </div>
        </div>

        <div class="observ-review__actions">
          <button type="submit" class="observ-button observ-button--primary observ-button--lg">
            Save & Next
            <span class="observ-review__action-shortcut">Enter</span>
          </button>

          <%= link_to dataset_run_path(@dataset, @run),
                      class: "observ-button observ-button--lg" do %>
            Skip & Exit
          <% end %>
        </div>
      <% end %>
    </div>
  </section>
</div>

<script>
  // Keyboard shortcuts for faster reviewing
  document.addEventListener('keydown', function(event) {
    // Ignore if user is typing in textarea
    if (event.target.tagName === 'TEXTAREA' || event.target.tagName === 'INPUT') {
      return;
    }

    if (event.key === 'c' || event.key === 'C') {
      document.querySelector('input[name="value"][value="1"]').checked = true;
    } else if (event.key === 'x' || event.key === 'X') {
      document.querySelector('input[name="value"][value="0"]').checked = true;
    } else if (event.key === 'Enter') {
      const form = document.querySelector('.observ-review__form');
      const selected = document.querySelector('input[name="value"]:checked');
      if (selected) {
        form.submit();
      }
    }
  });
</script>
