<% content_for :title, "Compare Versions" %>

<% content_for :page_header do %>
  <div class="observ-page-header__content">
    <div>
      <%= link_to "â† Back to Prompt", prompt_path(@prompt_name), class: "observ-link" %>
      <h1 class="observ-page-header__title">Compare Versions</h1>
      <p class="observ-prompt-header__subtitle"><%= @prompt_name %></p>
    </div>
  </div>
<% end %>

<div class="observ-container">
  <!-- Version Selector -->
  <div class="observ-card">
    <div class="observ-card__body">
      <%= form_with url: compare_prompt_path(@prompt_name), method: :get, class: "observ-compare__selector" do |f| %>

        <div class="observ-compare__field">
          <%= f.label :from, "From Version", class: "observ-form__label" %>
          <%= f.select :from,
            options_for_select(
              Observ::Prompt.where(name: @prompt_name).order(version: :desc).map { |v|
                ["v#{v.version} (#{v.state})", v.version]
              },
              params[:from]
            ),
            {},
            class: "observ-form__select" %>
        </div>

        <div class="observ-compare__field">
          <%= f.label :to, "To Version", class: "observ-form__label" %>
          <%= f.select :to,
            options_for_select(
              Observ::Prompt.where(name: @prompt_name).order(version: :desc).map { |v|
                ["v#{v.version} (#{v.state})", v.version]
              },
              params[:to]
            ),
            {},
            class: "observ-form__select" %>
        </div>

        <%= f.submit "Compare", class: "observ-button observ-button--primary" %>
      <% end %>
    </div>
  </div>

  <!-- Metadata Comparison -->
  <div class="observ-card">
    <div class="observ-compare__grid">
      <div class="observ-compare__panel observ-compare__panel--left">
        <div class="observ-compare__version-header">
          <h2 class="observ-compare__version-title">Version <%= @from_version.version %></h2>
          <span class="observ-badge <%= case @from_version.state
              when 'draft' then 'observ-badge--warning'
              when 'production' then 'observ-badge--success'
              when 'archived' then 'observ-badge--default'
              end %>">
            <%= @from_version.state %>
          </span>
        </div>

        <dl class="observ-compare__metadata">
          <div class="observ-compare__metadata-item">
            <dt>Created</dt>
            <dd><%= @from_version.created_at.strftime("%b %d, %Y %I:%M %p") %></dd>
          </div>
          <div class="observ-compare__metadata-item">
            <dt>Created By</dt>
            <dd><%= @from_version.created_by || "system" %></dd>
          </div>
          <% if @from_version.commit_message.present? %>
            <div class="observ-compare__metadata-item">
              <dt>Commit Message</dt>
              <dd class="observ-compare__metadata-item--italic">"<%= @from_version.commit_message %>"</dd>
            </div>
          <% end %>
        </dl>
      </div>

      <div class="observ-compare__panel">
        <div class="observ-compare__version-header">
          <h2 class="observ-compare__version-title">Version <%= @to_version.version %></h2>
          <span class="observ-badge <%= case @to_version.state
              when 'draft' then 'observ-badge--warning'
              when 'production' then 'observ-badge--success'
              when 'archived' then 'observ-badge--default'
              end %>">
            <%= @to_version.state %>
          </span>
        </div>

        <dl class="observ-compare__metadata">
          <div class="observ-compare__metadata-item">
            <dt>Created</dt>
            <dd><%= @to_version.created_at.strftime("%b %d, %Y %I:%M %p") %></dd>
          </div>
          <div class="observ-compare__metadata-item">
            <dt>Created By</dt>
            <dd><%= @to_version.created_by || "system" %></dd>
          </div>
          <% if @to_version.commit_message.present? %>
            <div class="observ-compare__metadata-item">
              <dt>Commit Message</dt>
              <dd class="observ-compare__metadata-item--italic">"<%= @to_version.commit_message %>"</dd>
            </div>
          <% end %>
        </dl>
      </div>
    </div>
  </div>

  <!-- Side-by-Side Diff -->
  <div class="observ-card">
    <div class="observ-card__header">
      <h2 class="observ-compare__section-title">Prompt Content Comparison</h2>
    </div>

    <div class="observ-compare__grid">
      <!-- Left: From Version -->
      <div class="observ-compare__panel observ-compare__panel--left">
        <div class="observ-compare__content-block">
          <pre><%= render "diff_content", content: @from_version.prompt, diff: @diff, side: :from %></pre>
        </div>
      </div>

      <!-- Right: To Version -->
      <div class="observ-compare__panel">
        <div class="observ-compare__content-block">
          <pre><%= render "diff_content", content: @to_version.prompt, diff: @diff, side: :to %></pre>
        </div>
      </div>
    </div>
  </div>

  <!-- Config Comparison -->
  <% if @from_version.config.present? || @to_version.config.present? %>
    <div class="observ-card">
      <div class="observ-card__header">
        <h2 class="observ-compare__section-title">Configuration Comparison</h2>
      </div>

      <div class="observ-compare__grid">
        <div class="observ-compare__panel observ-compare__panel--left">
          <div class="observ-compare__content-block">
            <pre><%= JSON.pretty_generate(@from_version.config) %></pre>
          </div>
        </div>
        <div class="observ-compare__panel">
          <div class="observ-compare__content-block">
            <pre><%= JSON.pretty_generate(@to_version.config) %></pre>
          </div>
        </div>
      </div>
    </div>
  <% end %>
</div>
