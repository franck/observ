<% content_for :title, "Sessions" %>

<% content_for :page_header do %>
  <div class="observ-page-header__content">
    <h1 class="observ-page-header__title">Sessions</h1>
  </div>
<% end %>

<div class="observ-container">
  <!-- Filters -->
  <section class="observ-card observ-filters">
    <div class="observ-card__body">
      <%= form_with url: sessions_path, method: :get, class: "observ-filters__form" do |f| %>
        <div class="observ-filters__field observ-filters__field--md">
          <%= f.label "filter[agent_type]", "Agent", class: "observ-filters__label" %>
          <%= f.select "filter[agent_type]",
            options_for_select(
              [["All Agents", ""]] + @agent_types.map { |t| [t, t] },
              params.dig(:filter, :agent_type)
            ),
            {},
            class: "observ-filters__select" %>
        </div>

        <div class="observ-filters__field observ-filters__field--flex">
          <%= f.label "filter[user_id]", "User ID", class: "observ-filters__label" %>
          <%= f.text_field "filter[user_id]",
            value: params.dig(:filter, :user_id),
            placeholder: "Filter by user ID...",
            class: "observ-filters__input" %>
        </div>

        <div class="observ-filters__field observ-filters__field--md">
          <%= f.label "filter[start_date]", "From", class: "observ-filters__label" %>
          <%= f.date_field "filter[start_date]",
            value: params.dig(:filter, :start_date),
            class: "observ-filters__input" %>
        </div>

        <div class="observ-filters__field observ-filters__field--md">
          <%= f.label "filter[end_date]", "To", class: "observ-filters__label" %>
          <%= f.date_field "filter[end_date]",
            value: params.dig(:filter, :end_date),
            class: "observ-filters__input" %>
        </div>

        <div class="observ-filters__field observ-filters__field--md">
          <%= f.label "filter[status]", "Status", class: "observ-filters__label" %>
          <%= f.select "filter[status]",
            options_for_select(
              [["All", ""], ["Completed", "completed"], ["In Progress", "in_progress"]],
              params.dig(:filter, :status)
            ),
            {},
            class: "observ-filters__select" %>
        </div>

        <div class="observ-filters__actions">
          <%= f.submit "Filter", class: "observ-button observ-button--secondary" %>
          <%= link_to "Clear", sessions_path, class: "observ-button" %>
        </div>
      <% end %>
    </div>
  </section>

  <!-- Sessions Table -->
  <section class="observ-card">
    <div class="observ-card__body">
      <% if @sessions.any? %>
        <table class="observ-table">
          <thead class="observ-table__header">
            <tr class="observ-table__row">
              <th class="observ-table__cell">Session ID</th>
              <th class="observ-table__cell">Agent</th>
              <th class="observ-table__cell">User ID</th>
              <th class="observ-table__cell">Start Time</th>
              <th class="observ-table__cell">Duration</th>
              <th class="observ-table__cell observ-table__cell--numeric">Traces</th>
              <th class="observ-table__cell observ-table__cell--numeric">Tokens</th>
              <th class="observ-table__cell observ-table__cell--numeric">Cost</th>
              <th class="observ-table__cell observ-table__cell--numeric">Annotations</th>
              <th class="observ-table__cell">Status</th>
              <th class="observ-table__cell"></th>
            </tr>
          </thead>
          <tbody>
            <% @sessions.each do |session| %>
              <tr class="observ-table__row">
                <td class="observ-table__cell">
                  <code class="observ-code observ-code--inline"><%= truncate_id(session.session_id, 12) %></code>
                </td>
                <td class="observ-table__cell">
                  <%= session.metadata&.dig("agent_type") || "—" %>
                </td>
                <td class="observ-table__cell">
                  <% if session.user_id.present? %>
                    <code class="observ-code observ-code--inline"><%= truncate_id(session.user_id, 8) %></code>
                  <% else %>
                    <span class="observ-text--muted">—</span>
                  <% end %>
                </td>
                <td class="observ-table__cell">
                  <%= observ_timestamp(session.start_time) %>
                </td>
                <td class="observ-table__cell">
                  <% if session.duration_s %>
                    <%= format_duration_s(session.duration_s) %>
                  <% else %>
                    <span class="observ-text--muted">In Progress</span>
                  <% end %>
                </td>
                <td class="observ-table__cell observ-table__cell--numeric">
                  <%= session.end_time ? session.total_traces_count : session.traces.count %>
                </td>
                <td class="observ-table__cell observ-table__cell--numeric">
                  <%= format_tokens(session.end_time ? session.total_tokens : session.traces.sum(:total_tokens)) %>
                </td>
                <td class="observ-table__cell observ-table__cell--numeric">
                  <%= format_currency(session.end_time ? session.total_cost : session.traces.sum(:total_cost)) %>
                </td>
                <td class="observ-table__cell observ-table__cell--numeric">
                  <% if session.annotations.any? %>
                    <span class="observ-badge observ-badge--info"><%= session.annotations.count %></span>
                  <% else %>
                    <span class="observ-text--muted">—</span>
                  <% end %>
                </td>
                <td class="observ-table__cell">
                  <%= observ_status_badge(observ_session_status(session)) %>
                </td>
                <td class="observ-table__cell observ-table__cell--actions">
                  <%= link_to "View", session_path(session), class: "observ-button observ-button--sm" %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      <% else %>
        <div class="observ-card__empty">
          <p>No sessions found.</p>
        </div>
      <% end %>
    </div>
  </section>

  <%= observ_pagination(@sessions) %>
</div>
