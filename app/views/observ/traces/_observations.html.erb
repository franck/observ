<%
  # Local variables:
  # - observations: collection of observations to display
  # - limit: optional, if set will show only first N observations
%>

<section class="observ-card">
  <header class="observ-card__header">
    <h2 class="observ-card__title">
      Observations (<%= observations.count %>)
      <% if local_assigns[:show_total] && local_assigns[:total_count] && total_count > observations.count %>
        of <%= total_count %>
      <% end %>
    </h2>
  </header>
  <div class="observ-card__body">
    <% if observations.any? %>
      <div class="observ-observations-list observ-observations-list--compact">
        <% observations.each do |observation| %>
          <div class="observ-observation-card observ-observation-card--compact observ-observation-card--<%= observation.type.demodulize.downcase %>">
            <div class="observ-observation-card__header">
              <span class="observ-observation-card__type-badge">
                <%= observation.type.demodulize %>
              </span>
              <h3 class="observ-observation-card__name"><%= observation.name %></h3>
              <div class="observ-observation-card__meta">
                <span class="observ-observation-card__id">
                  <code class="observ-code observ-code--inline"><%= truncate_id(observation.observation_id, 8) %></code>
                </span>
              </div>
            </div>
            
            <div class="observ-observation-card__body">
              <dl class="observ-definition-list observ-definition-list--horizontal observ-definition-list--compact">
                <% if observation.is_a?(Observ::Generation) %>
                  <div class="observ-definition-list__item">
                    <dt class="observ-definition-list__term">Model</dt>
                    <dd class="observ-definition-list__definition">
                      <%= observ_model_badge(observation.model) %>
                    </dd>
                  </div>
                  <div class="observ-definition-list__item">
                    <dt class="observ-definition-list__term">Tokens</dt>
                    <dd class="observ-definition-list__definition">
                      <%= format_tokens(observation.total_tokens) %>
                    </dd>
                  </div>
                  <div class="observ-definition-list__item">
                    <dt class="observ-definition-list__term">Cost</dt>
                    <dd class="observ-definition-list__definition">
                      <%= format_currency(observation.cost_usd) %>
                    </dd>
                  </div>
                  <% if observation.finish_reason %>
                    <div class="observ-definition-list__item">
                      <dt class="observ-definition-list__term">Finish</dt>
                      <dd class="observ-definition-list__definition">
                        <%= observation.finish_reason %>
                      </dd>
                    </div>
                  <% end %>
                  <% if observation.time_to_first_token_ms %>
                    <div class="observ-definition-list__item">
                      <dt class="observ-definition-list__term">TTFT</dt>
                      <dd class="observ-definition-list__definition">
                        <%= format_duration_ms(observation.time_to_first_token_ms) %>
                      </dd>
                    </div>
                  <% end %>
                  <div class="observ-definition-list__item">
                    <dt class="observ-definition-list__term">Prompt</dt>
                    <dd class="observ-definition-list__definition">
                      <% if observation.prompt_name.present? %>
                        <%= observation.prompt_name %>
                        <% if observation.prompt_version.present? %>
                          <span class="observ-text--muted">(v<%= observation.prompt_version %>)</span>
                        <% end %>
                      <% else %>
                        <span class="observ-text--muted">default prompt</span>
                      <% end %>
                    </dd>
                  </div>
                <% end %>
                <div class="observ-definition-list__item">
                  <dt class="observ-definition-list__term">Duration</dt>
                  <dd class="observ-definition-list__definition">
                    <% if observation.duration_ms %>
                      <%= format_duration_ms(observation.duration_ms) %>
                    <% else %>
                      <span class="observ-text--muted">—</span>
                    <% end %>
                  </dd>
                </div>
                <% if observation.is_a?(Observ::Span) && observation.status_message %>
                  <div class="observ-definition-list__item">
                    <dt class="observ-definition-list__term">Status</dt>
                    <dd class="observ-definition-list__definition">
                      <%= observation.status_message %>
                    </dd>
                  </div>
                <% end %>
              </dl>
            </div>

            <% if observation.is_a?(Observ::Generation) && observation.usage.present? && observation.usage.any? %>
              <div class="observ-observation-card__section observ-observation-card__section--compact">
                <h4 class="observ-observation-card__section-title">Token Usage</h4>
                <dl class="observ-definition-list observ-definition-list--horizontal observ-definition-list--compact">
                  <% observation.usage.each do |key, value| %>
                    <div class="observ-definition-list__item">
                      <dt class="observ-definition-list__term"><%= key.humanize %></dt>
                      <dd class="observ-definition-list__definition"><%= format_tokens(value) %></dd>
                    </div>
                  <% end %>
                </dl>
              </div>
            <% end %>

            <% if observation.input.present? %>
              <div class="observ-observation-card__section observ-observation-card__section--compact">
                <h4 class="observ-observation-card__section-title">Input</h4>
                <%= render_input_output(observation.input, compact: true) %>
              </div>
            <% end %>

            <% if observation.output.present? %>
              <div class="observ-observation-card__section observ-observation-card__section--compact">
                <h4 class="observ-observation-card__section-title">Output</h4>
                <%= render_input_output(observation.output, compact: true) %>
              </div>
            <% end %>

            <% if observation.is_a?(Observ::Generation) && observation.messages.present? && observation.messages.any? %>
              <div class="observ-observation-card__section observ-observation-card__section--compact">
                <h4 class="observ-observation-card__section-title">Messages</h4>
                <%= render_json_viewer(observation.messages, compact: true) %>
              </div>
            <% end %>

            <% if observation.is_a?(Observ::Generation) && observation.provider_metadata.present? && observation.provider_metadata.any? %>
              <div class="observ-observation-card__section observ-observation-card__section--compact">
                <h4 class="observ-observation-card__section-title">Provider Metadata</h4>
                <%= render_json_viewer(observation.provider_metadata, compact: true) %>
              </div>
            <% end %>

            <% if observation.is_a?(Observ::Span) && observation.metadata.present? && observation.metadata.any? %>
              <div class="observ-observation-card__section observ-observation-card__section--compact">
                <h4 class="observ-observation-card__section-title">Metadata</h4>
                <%= render_json_viewer(observation.metadata, compact: true) %>
              </div>
            <% end %>

            <div class="observ-observation-card__footer">
              <%= link_to "View Details →", observation_path(observation), class: "observ-link" %>
            </div>
          </div>
        <% end %>
      </div>
      <% if local_assigns[:show_total] && local_assigns[:total_count] && total_count > observations.count %>
        <p class="observ-text--muted observ-review-preview-notice">
          Showing first <%= observations.count %> observations. 
          <%= link_to "View all #{total_count} observations", trace_path(trace), class: "observ-link", target: "_blank" %>
        </p>
      <% end %>
    <% else %>
      <div class="observ-card__empty">
        <p>No observations found for this trace.</p>
      </div>
    <% end %>
  </div>
</section>
