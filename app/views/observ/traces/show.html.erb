<% content_for :title, "Trace #{truncate_id(@trace.trace_id, 12)}" %>

<% content_for :page_header do %>
  <div class="observ-page-header__content">
    <div class="observ-page-header__breadcrumb">
      <%= link_to "Traces", traces_path, class: "observ-link" %> /
    </div>
    <h1 class="observ-page-header__title">
      Trace <code class="observ-code observ-code--inline"><%= truncate_id(@trace.trace_id, 12) %></code>
    </h1>
    <div class="observ-page-header__meta">
      <%= observ_status_badge(observ_trace_status(@trace)) %>
    </div>
  </div>
  <div class="observ-page-header__actions">
    <%= link_to "#", 
        class: "observ-button observ-button--primary observ-button--sm",
        data: { 
          action: "click->observ--drawer#open", 
          drawer_url_param: annotations_drawer_trace_path(@trace)
        } do %>
      Annotate
      <% if @trace.annotations.any? %>
        <span class="observ-badge observ-badge--light"><%= @trace.annotations.count %></span>
      <% end %>
    <% end %>
  </div>
<% end %>

<div class="observ-container">
  <section class="observ-card observ-card--compact">
    <header class="observ-card__header">
      <h2 class="observ-card__title">Details</h2>
    </header>
    <div class="observ-card__body">
      <dl class="observ-definition-list observ-definition-list--compact">
        <div class="observ-definition-list__item">
          <dt class="observ-definition-list__term">Session</dt>
          <dd class="observ-definition-list__definition">
            <%= link_to truncate_id(@trace.observ_session.session_id, 12), session_path(@trace.observ_session), class: "observ-link" %>
          </dd>
        </div>
        <div class="observ-definition-list__item">
          <dt class="observ-definition-list__term">Name</dt>
          <dd class="observ-definition-list__definition"><%= @trace.name || "—" %></dd>
        </div>
        <div class="observ-definition-list__item">
          <dt class="observ-definition-list__term">Start Time</dt>
          <dd class="observ-definition-list__definition"><%= observ_timestamp(@trace.start_time) %></dd>
        </div>
        <% if @trace.end_time %>
          <div class="observ-definition-list__item">
            <dt class="observ-definition-list__term">End Time</dt>
            <dd class="observ-definition-list__definition"><%= observ_timestamp(@trace.end_time) %></dd>
          </div>
        <% end %>
        <div class="observ-definition-list__item">
          <dt class="observ-definition-list__term">Duration</dt>
          <dd class="observ-definition-list__definition">
            <% if @trace.duration_ms %>
              <%= format_duration_ms(@trace.duration_ms) %>
            <% else %>
              <span class="observ-text--muted">In Progress</span>
            <% end %>
          </dd>
        </div>
        <div class="observ-definition-list__item">
          <dt class="observ-definition-list__term">Total Tokens</dt>
          <dd class="observ-definition-list__definition"><%= format_tokens(@trace.total_tokens) %></dd>
        </div>
        <div class="observ-definition-list__item">
          <dt class="observ-definition-list__term">Total Cost</dt>
          <dd class="observ-definition-list__definition"><%= format_currency(@trace.total_cost) %></dd>
        </div>
      </dl>
    </div>
  </section>

  <% if @trace.input.present? %>
    <section class="observ-card observ-card--compact">
      <header class="observ-card__header">
        <h2 class="observ-card__title">Input</h2>
      </header>
      <div class="observ-card__body">
        <pre class="observ-code-block observ-code-block--compact"><%= @trace.input %></pre>
      </div>
    </section>
  <% end %>

  <% if @trace.output.present? %>
    <section class="observ-card observ-card--compact">
      <header class="observ-card__header">
        <h2 class="observ-card__title">Output</h2>
      </header>
      <div class="observ-card__body">
        <pre class="observ-code-block observ-code-block--compact"><%= @trace.output %></pre>
      </div>
    </section>
  <% end %>

  <% if @trace.metadata.present? && @trace.metadata.any? %>
    <section class="observ-card observ-card--compact">
      <header class="observ-card__header">
        <h2 class="observ-card__title">Metadata</h2>
      </header>
      <div class="observ-card__body">
        <pre class="observ-code-block observ-code-block--compact"><%= JSON.pretty_generate(@trace.metadata) %></pre>
      </div>
    </section>
  <% end %>

  <section class="observ-card">
    <header class="observ-card__header">
      <h2 class="observ-card__title">Observations (<%= @observations.count %>)</h2>
    </header>
    <div class="observ-card__body">
      <% if @observations.any? %>
        <div class="observ-observations-list observ-observations-list--compact">
          <% @observations.each do |observation| %>
            <div class="observ-observation-card observ-observation-card--compact observ-observation-card--<%= observation.type.demodulize.downcase %>">
              <div class="observ-observation-card__header">
                <span class="observ-observation-card__type-badge">
                  <%= observation.type.demodulize %>
                </span>
                <h3 class="observ-observation-card__name"><%= observation.name %></h3>
                <div class="observ-observation-card__meta">
                  <span class="observ-observation-card__id">
                    <code class="observ-code observ-code--inline"><%= truncate_id(observation.observation_id, 8) %></code>
                  </span>
                </div>
              </div>
              
              <div class="observ-observation-card__body">
                <dl class="observ-definition-list observ-definition-list--horizontal observ-definition-list--compact">
                  <% if observation.is_a?(Observ::Generation) %>
                    <div class="observ-definition-list__item">
                      <dt class="observ-definition-list__term">Model</dt>
                      <dd class="observ-definition-list__definition">
                        <%= observ_model_badge(observation.model) %>
                      </dd>
                    </div>
                    <div class="observ-definition-list__item">
                      <dt class="observ-definition-list__term">Tokens</dt>
                      <dd class="observ-definition-list__definition">
                        <%= format_tokens(observation.total_tokens) %>
                      </dd>
                    </div>
                    <div class="observ-definition-list__item">
                      <dt class="observ-definition-list__term">Cost</dt>
                      <dd class="observ-definition-list__definition">
                        <%= format_currency(observation.cost_usd) %>
                      </dd>
                    </div>
                    <% if observation.finish_reason %>
                      <div class="observ-definition-list__item">
                        <dt class="observ-definition-list__term">Finish</dt>
                        <dd class="observ-definition-list__definition">
                          <%= observation.finish_reason %>
                        </dd>
                      </div>
                    <% end %>
                    <% if observation.time_to_first_token_ms %>
                      <div class="observ-definition-list__item">
                        <dt class="observ-definition-list__term">TTFT</dt>
                        <dd class="observ-definition-list__definition">
                          <%= format_duration_ms(observation.time_to_first_token_ms) %>
                        </dd>
                      </div>
                    <% end %>
                  <% end %>
                  <div class="observ-definition-list__item">
                    <dt class="observ-definition-list__term">Duration</dt>
                    <dd class="observ-definition-list__definition">
                      <% if observation.duration_ms %>
                        <%= format_duration_ms(observation.duration_ms) %>
                      <% else %>
                        <span class="observ-text--muted">—</span>
                      <% end %>
                    </dd>
                  </div>
                  <% if observation.is_a?(Observ::Span) && observation.status_message %>
                    <div class="observ-definition-list__item">
                      <dt class="observ-definition-list__term">Status</dt>
                      <dd class="observ-definition-list__definition">
                        <%= observation.status_message %>
                      </dd>
                    </div>
                  <% end %>
                </dl>
              </div>

              <% if observation.is_a?(Observ::Generation) && observation.usage.present? && observation.usage.any? %>
                <div class="observ-observation-card__section observ-observation-card__section--compact">
                  <h4 class="observ-observation-card__section-title">Token Usage</h4>
                  <dl class="observ-definition-list observ-definition-list--horizontal observ-definition-list--compact">
                    <% observation.usage.each do |key, value| %>
                      <div class="observ-definition-list__item">
                        <dt class="observ-definition-list__term"><%= key.humanize %></dt>
                        <dd class="observ-definition-list__definition"><%= format_tokens(value) %></dd>
                      </div>
                    <% end %>
                  </dl>
                </div>
              <% end %>

              <% if observation.input.present? %>
                <div class="observ-observation-card__section observ-observation-card__section--compact">
                  <h4 class="observ-observation-card__section-title">Input</h4>
                  <pre class="observ-code-block observ-code-block--compact"><%= observation.input %></pre>
                </div>
              <% end %>

              <% if observation.output.present? %>
                <div class="observ-observation-card__section observ-observation-card__section--compact">
                  <h4 class="observ-observation-card__section-title">Output</h4>
                  <pre class="observ-code-block observ-code-block--compact"><%= observation.output %></pre>
                </div>
              <% end %>

              <% if observation.is_a?(Observ::Generation) && observation.messages.present? && observation.messages.any? %>
                <div class="observ-observation-card__section observ-observation-card__section--compact">
                  <h4 class="observ-observation-card__section-title">Messages</h4>
                  <pre class="observ-code-block observ-code-block--compact"><%= JSON.pretty_generate(observation.messages) %></pre>
                </div>
              <% end %>

              <% if observation.is_a?(Observ::Generation) && observation.provider_metadata.present? && observation.provider_metadata.any? %>
                <div class="observ-observation-card__section observ-observation-card__section--compact">
                  <h4 class="observ-observation-card__section-title">Provider Metadata</h4>
                  <pre class="observ-code-block observ-code-block--compact"><%= JSON.pretty_generate(observation.provider_metadata) %></pre>
                </div>
              <% end %>

              <% if observation.is_a?(Observ::Span) && observation.metadata.present? && observation.metadata.any? %>
                <div class="observ-observation-card__section observ-observation-card__section--compact">
                  <h4 class="observ-observation-card__section-title">Metadata</h4>
                  <pre class="observ-code-block observ-code-block--compact"><%= JSON.pretty_generate(observation.metadata) %></pre>
                </div>
              <% end %>

              <div class="observ-observation-card__footer">
                <%= link_to "View Details →", observation_path(observation), class: "observ-link" %>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="observ-card__empty">
          <p>No observations found for this trace.</p>
        </div>
      <% end %>
    </div>
  </section>
</div>
